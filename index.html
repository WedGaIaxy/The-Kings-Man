<!-- The King's Man Version 2.8 (WORKING LOCAL VERSION) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The King's Man</title>
  <style>
    body {
      background-color: #111;
      color: #eee;
      font-family: 'Courier New', monospace;
      padding: 20px;
      transition: background-color 1s, color 1s;
    }
    .text-line { margin: 10px 0; }
    .choices { margin-top: 10px; }
    button {
      margin: 5px;
      padding: 10px;
      background-color: #333;
      color: #eee;
      border: 1px solid #555;
      cursor: pointer;
    }
    button:hover { background-color: #555; }
    .glow { color: #00f0ff; text-shadow: 0 0 10px #00f0ff; }
    .void { letter-spacing: 5px; color: #DEDEDE; text-shadow: 0 0 10px #EEEEEE; }
    .corrode span {
      transition: opacity 0.05s;
      display: inline-block;
    }
    .day-mode { background-color: #606060; color: #222; }
    #inventory {
      display: none;
      position: fixed;
      top: 50px;
      right: 50px;
      background: #222;
      color: #eee;
      padding: 10px;
      border: 1px solid #555;
      z-index: 1000;
    }
    #inventory h3 { margin-top: 0; }
    #inventory-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #inventory-list li {
      margin: 5px 0;
      cursor: help;
    }
  </style>

  <!-- PapaParse CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="story"></div>
  <div class="choices" id="choices"></div>
  <div id="inventory">
    <h3>Inventory</h3>
    <ul id="inventory-list"></ul>
  </div>
<script>
const CSV_URL = "https://script.google.com/macros/s/AKfycbxWdIXi9Uqwv4S3ADxUtXmRvWuSBaNG-binmlCXTH9BU5J8m0-8ZCprCI3v-GtsYR9y/exec";

const storyElement = document.getElementById('story');
const choicesElement = document.getElementById('choices');
const inventoryElement = document.getElementById('inventory');
const inventoryList = document.getElementById('inventory-list');

let inventory = [];
let flags = {};
let scenes = {};

const itemDescriptions = {
  "sword": "This sword hums softly when held.",
  "key": "A key, nothing special about it.",
  "code clue": "A scrap of paper with 2034 scrawled in charcoal."
};

function addToInventory(item) {
  if (inventory.length < 5 && !inventory.includes(item)) {
    inventory.push(item);
    updateInventoryDisplay();
  }
}
function updateInventoryDisplay() {
  inventoryList.innerHTML = '';
  inventory.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    li.title = itemDescriptions[item] || '';
    inventoryList.appendChild(li);
  });
}
function hasItem(item) {
  return inventory.includes(item);
}
document.addEventListener('keydown', (e) => {
  if (e.key.toLowerCase() === 'e') {
    inventoryElement.style.display = inventoryElement.style.display === 'none' ? 'block' : 'none';
  }
});
function applyGlobalEffect(tag) {
  if (tag === 'day') document.body.classList.add('day-mode');
  else if (tag === 'night') document.body.classList.remove('day-mode');
}
function typeLine(rawText, callback) {
  rawText = rawText.trim();
  rawText = rawText.replace(/\\n/g, '\n');
  const parts = [];
  const regex = /\[(\w+)\](.*?)\[\/\1\]/g;
  let lastIndex = 0, match;
  while ((match = regex.exec(rawText)) !== null) {
    if (match.index > lastIndex) parts.push({ text: rawText.substring(lastIndex, match.index), effect: null });
    parts.push({ text: match[2], effect: match[1].toLowerCase() });
    lastIndex = regex.lastIndex;
  }
  if (lastIndex < rawText.length) parts.push({ text: rawText.substring(lastIndex), effect: null });

  const line = document.createElement('div');
  line.className = 'text-line';
  storyElement.appendChild(line);

  let partIndex = 0;
  function typePart() {
    if (partIndex >= parts.length) {
      const corrodeSpans = [...line.querySelectorAll('.corrode span')];
      if (corrodeSpans.length > 0) {
        setTimeout(() => fadeOutChars(corrodeSpans, callback), 500);
      } else if (callback) callback();
      return;
    }
    const part = parts[partIndex];
    const chars = part.text.split('');
    const span = document.createElement('span');
    if (part.effect) span.classList.add(part.effect);
    line.appendChild(span);

    let i = 0;
    function typeChar() {
      if (i < chars.length) {
        const charSpan = document.createElement('span');
        charSpan.textContent = chars[i];
        span.appendChild(charSpan);
        i++;
        setTimeout(typeChar, 30);
      } else {
        partIndex++;
        typePart();
      }
    }
    typeChar();
  }
  function fadeOutChars(charSpans, done) {
    let j = 0;
    function fadeNext() {
      if (j < charSpans.length) {
        charSpans[j].style.opacity = '0';
        j++;
        setTimeout(fadeNext, 30);
      } else if (done) done();
    }
    fadeNext();
  }
  typePart();
}
function showScene(id, clear = false) {
  const scene = scenes[id];
  if (!scene) {
    console.error(`Scene with id "${id}" not found.`);
    storyElement.innerHTML = `<p>Scene "${id}" not found.</p>`;
    return;
  }

  if (clear) storyElement.innerHTML = '';
  choicesElement.innerHTML = '';

  const lines = scene.text.split(/\n+/);
  let current = 0;

  function nextLine() {
    if (current < lines.length) {
      typeLine(lines[current].trim(), () => {
        storyElement.appendChild(document.createElement('br'));
        current++;
        nextLine();
      });
    } else {
      scene.choices.forEach(choice => {
        if (choice.requires && !hasItem(choice.requires)) return;
        if (choice.flagRequired && !flags[choice.flagRequired]) return;

        const btn = document.createElement('button');
        btn.textContent = choice.text;

        if (choice.hover && (!choice.hoverRequires || hasItem(choice.hoverRequires))) {
          btn.title = choice.hover;
        }

        btn.onclick = () => {
          if (choice.item) addToInventory(choice.item);
          if (choice.setFlag) flags[choice.setFlag] = true;
          showScene(choice.next);
        };
        choicesElement.appendChild(btn);
      });
    }
  }

  nextLine();
}

function loadScenesFromCSV(csv) {
  console.log("CSV raw data:", csv); // debug log

  // Parse CSV using PapaParse with headers
  const results = Papa.parse(csv, {
    header: true,
    skipEmptyLines: true
  });

  if (results.errors.length) {
    console.error("PapaParse errors:", results.errors);
    storyElement.innerHTML = "<p>Error parsing CSV data.</p>";
    return;
  }

  console.log("Parsed CSV data:", results.data); // debug log

  const sceneMap = {};

  results.data.forEach(rowData => {
    const id = rowData.id.trim().toLowerCase();

    if (!sceneMap[id]) {
      sceneMap[id] = { text: rowData.text || '', choices: [] };
    }

    if (rowData["choice text"]) {
      sceneMap[id].choices.push({
        text: rowData["choice text"],
        next: rowData["next id"],
        item: rowData["item"] || undefined,
        requires: rowData["requires item"] || undefined,
        setFlag: rowData["flag"] || undefined,
        flagRequired: rowData["requires flag"] || undefined,
        hover: rowData["hover"] || undefined,
        hoverRequires: rowData["requires hover"] || undefined
      });
    }
  });

  scenes = sceneMap;
  showScene("intro", true);
}

fetch(CSV_URL)
  .then(res => {
    if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
    return res.text();
  })
  .then(csv => loadScenesFromCSV(csv))
  .catch(err => {
    console.error("Failed to load CSV:", err);
    storyElement.innerHTML = "<p>Failed to load story data.</p>";
  });
</script>
</body>
</html>


